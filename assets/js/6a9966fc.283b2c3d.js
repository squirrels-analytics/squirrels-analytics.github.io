"use strict";(self.webpackChunksquirrels_docs=self.webpackChunksquirrels_docs||[]).push([[7999],{2145:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>t,contentTitle:()=>r,default:()=>m,frontMatter:()=>a,metadata:()=>c,toc:()=>i});const c=JSON.parse('{"id":"docs/concepts/macros","title":"Macros","description":"SQL data models are written in Jinja templates. Jinja has a concept known as macros that allows you to reuse similarly structured text in multiple places, including across different files.","source":"@site/docs/docs/concepts/macros.md","sourceDirName":"docs/concepts","slug":"/docs/concepts/macros","permalink":"/docs/docs/concepts/macros","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Context Variables & Placeholders","permalink":"/docs/docs/concepts/context"},"next":{"title":"Data Models","permalink":"/docs/docs/concepts/models"}}');var s=o(4848),l=o(8453);const a={},r="Macros",t={},i=[{value:"Macros in a Squirrels Project",id:"macros-in-a-squirrels-project",level:2},{value:"Example",id:"example",level:3},{value:"Sharing Macros Between Projects",id:"sharing-macros-between-projects",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"macros",children:"Macros"})}),"\n",(0,s.jsxs)(n.p,{children:["SQL data models are written in ",(0,s.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/",children:"Jinja"})," templates. Jinja has a concept known as ",(0,s.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/templates/#macros",children:"macros"})," that allows you to reuse similarly structured text in multiple places, including across different files."]}),"\n",(0,s.jsx)(n.p,{children:"To give an example of how Jinja macros can be useful for SQL data models, consider the following example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT\n    (CASE WHEN col1 < 0.3 THEN 0.3 WHEN col1 < 0.6 THEN col1 ELSE 0.6 END) AS col1_clamped,\n    (CASE WHEN col2 < 0.2 THEN 0.2 WHEN col2 < 0.7 THEN col2 ELSE 0.7 END) AS col2_clamped,\n    (CASE WHEN col3 < 0.4 THEN 0.4 WHEN col3 < 0.6 THEN col3 ELSE 0.6 END) AS col3_clamped\nFROM mytable\n"})}),"\n",(0,s.jsx)(n.p,{children:'This SQL logic to "clamp" the value of a column looks similar for each column, but has slight variations. As the SQL query grows, maintaining the clamping logic across multiple columns becomes cumbersome.'}),"\n",(0,s.jsx)(n.p,{children:"To address this, we can define a macro that encapsulates the clamping logic:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"{%- macro clamp(column, min, max) -%}\n    (CASE WHEN {{ column }} < {{ min }} THEN {{ min }} WHEN {{ column }} < {{ max }} THEN {{ column }} ELSE {{ max }} END)\n{%- endmacro -%}\n\nSELECT\n    {{ clamp('col1', 0.3, 0.6) }} AS col1_clamped,\n    {{ clamp('col2', 0.2, 0.7) }} AS col2_clamped,\n    {{ clamp('col3', 0.4, 0.6) }} AS col3_clamped\nFROM mytable\n"})}),"\n",(0,s.jsx)(n.p,{children:"When rendered using Jinja, the two SQL queries above will produce the same result."}),"\n",(0,s.jsx)(n.h2,{id:"macros-in-a-squirrels-project",children:"Macros in a Squirrels Project"}),"\n",(0,s.jsxs)(n.p,{children:["In a Squirrels project, macros should be defined in the ",(0,s.jsx)(n.code,{children:"macros/"})," folder of the project. Squirrels will automatically read all files in the ",(0,s.jsx)(n.code,{children:"macros/"}),' folder with the extension ".sql", ".j2", ".jinja", or ".jinja2" to load macros.']}),"\n",(0,s.jsxs)(n.p,{children:['There is no need to use Jinja\'s "include" or "import" syntax to load the macros unless the file is outside the ',(0,s.jsx)(n.code,{children:"macros/"})," folder."]}),"\n",(0,s.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,s.jsxs)(n.p,{children:["If you define a file named ",(0,s.jsx)(n.code,{children:"macros/utils.sql"})," with the following content:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"{%- macro clamp(column, min, max) -%}\n    (CASE WHEN {{ column }} < {{ min }} THEN {{ min }} WHEN {{ column }} < {{ max }} THEN {{ column }} ELSE {{ max }} END)\n{%- endmacro -%}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then you can use the ",(0,s.jsx)(n.code,{children:"clamp"})," macro in any SQL file in the ",(0,s.jsx)(n.code,{children:"models/"})," folder (and can be used in multiple files):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT\n    {{ clamp('col1', 0.3, 0.6) }} AS col1_clamped,\n    {{ clamp('col2', 0.2, 0.7) }} AS col2_clamped,\n    {{ clamp('col3', 0.4, 0.6) }} AS col3_clamped\nFROM mytable\n"})}),"\n",(0,s.jsx)(n.h2,{id:"sharing-macros-between-projects",children:"Sharing Macros Between Projects"}),"\n",(0,s.jsxs)(n.p,{children:["You can use ",(0,s.jsx)(n.a,{href:"../../references/cli/deps",children:"sqrl deps"})," to load git repos with a ",(0,s.jsx)(n.code,{children:"macros/"})," folder into the ",(0,s.jsx)(n.code,{children:"sqrl_packages/"})," folder of your project. Squirrels will automatically load the macros from the ",(0,s.jsx)(n.code,{children:"macros/"})," folder of all the loaded repos (in addition to the ",(0,s.jsx)(n.code,{children:"macros/"})," folder defined in your project)."]}),"\n",(0,s.jsxs)(n.p,{children:["See the documentation for ",(0,s.jsx)(n.a,{href:"../../references/cli/deps",children:"sqrl deps"})," for more information."]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"This allows dbt packages that are available through git to be used as a dependency in a Squirrels project, which allows you to share functionality across dbt and Squirrels projects."})})]})}function m(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>a,x:()=>r});var c=o(6540);const s={},l=c.createContext(s);function a(e){const n=c.useContext(l);return c.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),c.createElement(l.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunksquirrels_docs=self.webpackChunksquirrels_docs||[]).push([[7999],{2145:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"docs/concepts/macros","title":"Macros & Filters","description":"SQL data models are written in Jinja templates.","source":"@site/docs/docs/concepts/macros.md","sourceDirName":"docs/concepts","slug":"/docs/concepts/macros","permalink":"/docs/docs/concepts/macros","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Context Variables & Placeholders","permalink":"/docs/docs/concepts/context"},"next":{"title":"Column Types","permalink":"/docs/docs/concepts/column-types"}}');var o=s(4848),r=s(8453);const i={},a="Macros & Filters",t={},c=[{value:"Why Use Macros?",id:"why-use-macros",level:2},{value:"Macros in a Squirrels Project",id:"macros-in-a-squirrels-project",level:2},{value:"Built-in Macros",id:"built-in-macros",level:3},{value:"Example",id:"example",level:3},{value:"Sharing Macros Between Projects",id:"sharing-macros-between-projects",level:2},{value:"Filters",id:"filters",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"macros--filters",children:"Macros & Filters"})}),"\n",(0,o.jsxs)(n.p,{children:["SQL data models are written in ",(0,o.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/",children:"Jinja"})," templates."]}),"\n",(0,o.jsxs)(n.p,{children:["Jinja has a concept known as ",(0,o.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/templates/#macros",children:"macros"})," that allows you to reuse similarly structured text in multiple places, including across different files."]}),"\n",(0,o.jsxs)(n.p,{children:["Similarly, Jinja also comes with ",(0,o.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/templates/#filters",children:"filters"})," that are built-in functions that can be used to process the output of variables or expressions."]}),"\n",(0,o.jsx)(n.h2,{id:"why-use-macros",children:"Why Use Macros?"}),"\n",(0,o.jsx)(n.p,{children:"To give an example of how Jinja macros can be useful for SQL data models, consider the following example:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"SELECT\n    (CASE WHEN col1 < 0.3 THEN 0.3 WHEN col1 < 0.6 THEN col1 ELSE 0.6 END) AS col1_clamped,\n    (CASE WHEN col2 < 0.2 THEN 0.2 WHEN col2 < 0.7 THEN col2 ELSE 0.7 END) AS col2_clamped,\n    (CASE WHEN col3 < 0.4 THEN 0.4 WHEN col3 < 0.6 THEN col3 ELSE 0.6 END) AS col3_clamped\nFROM mytable\n"})}),"\n",(0,o.jsx)(n.p,{children:'This SQL logic to "clamp" the value of a column looks similar for each column, but has slight variations. As the SQL query grows, maintaining the clamping logic across multiple columns becomes cumbersome.'}),"\n",(0,o.jsx)(n.p,{children:"To address this, we can define a macro that encapsulates the clamping logic:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"{%- macro clamp(column, min, max) -%}\n    (CASE WHEN {{ column }} < {{ min }} THEN {{ min }} WHEN {{ column }} < {{ max }} THEN {{ column }} ELSE {{ max }} END)\n{%- endmacro -%}\n\nSELECT\n    {{ clamp('col1', 0.3, 0.6) }} AS col1_clamped,\n    {{ clamp('col2', 0.2, 0.7) }} AS col2_clamped,\n    {{ clamp('col3', 0.4, 0.6) }} AS col3_clamped\nFROM mytable\n"})}),"\n",(0,o.jsx)(n.p,{children:"When rendered using Jinja, the two SQL queries above will produce the same result."}),"\n",(0,o.jsx)(n.h2,{id:"macros-in-a-squirrels-project",children:"Macros in a Squirrels Project"}),"\n",(0,o.jsxs)(n.p,{children:["In a Squirrels project, macros should be defined in the ",(0,o.jsx)(n.code,{children:"macros/"})," folder of the project. Squirrels will automatically read all files in the ",(0,o.jsx)(n.code,{children:"macros/"}),' folder with the extension ".sql", ".j2", ".jinja", or ".jinja2" to load macros.']}),"\n",(0,o.jsxs)(n.p,{children:['There is no need to use Jinja\'s "include" or "import" syntax to load the macros unless the file is outside the ',(0,o.jsx)(n.code,{children:"macros/"})," folder."]}),"\n",(0,o.jsx)(n.h3,{id:"built-in-macros",children:"Built-in Macros"}),"\n",(0,o.jsx)(n.p,{children:"The following macros are built-in to the Squirrels framework which you do not need to define in your project:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"ref(name)"})," - available for all data models"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"source(name)"})," - available for dbview models only as an alias for ",(0,o.jsx)(n.code,{children:"ref(name)"})]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["These macros will output the appropriate table name for the given model, which may differ based on whether they come from the virtual data environment or the in-memory DuckDB database for instance. In addition, these macros will add the dependent model to the ",(0,o.jsx)(n.code,{children:"depends_on"})," property of the given model if it's not already present in the yaml file."]}),"\n",(0,o.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,o.jsxs)(n.p,{children:["If you define a file named ",(0,o.jsx)(n.code,{children:"macros/utils.sql"})," with the following content:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"{%- macro clamp(column, min, max) -%}\n    (CASE WHEN {{ column }} < {{ min }} THEN {{ min }} WHEN {{ column }} < {{ max }} THEN {{ column }} ELSE {{ max }} END)\n{%- endmacro -%}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Then you can use the ",(0,o.jsx)(n.code,{children:"clamp"})," macro in any SQL file in the ",(0,o.jsx)(n.code,{children:"models/"})," folder (and can be used in multiple files):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sql",children:"SELECT\n    {{ clamp('col1', 0.3, 0.6) }} AS col1_clamped,\n    {{ clamp('col2', 0.2, 0.7) }} AS col2_clamped,\n    {{ clamp('col3', 0.4, 0.6) }} AS col3_clamped\nFROM mytable\n"})}),"\n",(0,o.jsx)(n.h2,{id:"sharing-macros-between-projects",children:"Sharing Macros Between Projects"}),"\n",(0,o.jsxs)(n.p,{children:["You can use ",(0,o.jsx)(n.a,{href:"../../references/cli/deps",children:"sqrl deps"})," to load git repos with a ",(0,o.jsx)(n.code,{children:"macros/"})," folder into the ",(0,o.jsx)(n.code,{children:"sqrl_packages/"})," folder of your project. Squirrels will automatically load the macros from the ",(0,o.jsx)(n.code,{children:"macros/"})," folder of all the loaded repos (in addition to the ",(0,o.jsx)(n.code,{children:"macros/"})," folder defined in your project)."]}),"\n",(0,o.jsxs)(n.p,{children:["See the documentation for ",(0,o.jsx)(n.a,{href:"../../references/cli/deps",children:"sqrl deps"})," for more information."]}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsx)(n.p,{children:"This allows dbt packages that are available through git to be used as a dependency in a Squirrels project, which allows you to share functionality across dbt and Squirrels projects."})}),"\n",(0,o.jsx)(n.h2,{id:"filters",children:"Filters"}),"\n",(0,o.jsx)(n.p,{children:"First, see the following page for the list of built-in filters that are available in Jinja:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://jinja.palletsprojects.com/en/stable/templates/#builtin-filters",children:"https://jinja.palletsprojects.com/en/stable/templates/#builtin-filters"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"In addition, Squirrels provides the following added/changed filters:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"{{ value | join(d: str = ', ', attribute: str | None = None) }}"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["This is the same as Jinja's built-in ",(0,o.jsx)(n.code,{children:"join"}),' filter, but the default separator is "comma and space" instead of empty string.']}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:'{{ value | quote(q: str = "\'", attribute: str | None = None) }}'}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Enquotes the value with the given quote character."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"{{ value | quote_and_join(q: str = \"'\", d: str = ', ', attribute: str | None = None) }}"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Enquotes each element of the value with the given quote character and joins them with the given separator."}),"\n",(0,o.jsxs)(n.li,{children:["Note that ",(0,o.jsx)(n.code,{children:"{{ value | quote_and_join }}"})," is the same as ",(0,o.jsx)(n.code,{children:"{{ value | map('quote') | join }}"}),"."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var l=s(6540);const o={},r=l.createContext(o);function i(e){const n=l.useContext(r);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);